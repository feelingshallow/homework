<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="jquery-3.4.1.js"></script>
  <style>
    html,
    body {
      margin: 0;
      font-size: 14px;
    }
    .container {
      position: relative;
    }
    .box {
      position: absolute;
      left: 200px;
      top: 100px;
      width: 200px;
      height: 200px;
      color: #fff;
    }


    .rotate {
      position: absolute;
      right: 90px;
      bottom: -40px;
      width: 40px;
      height: 40px;
      background-color: royalblue;
      z-index: 3;
      cursor: se-resize;
      line-height: 40px;
      text-align: center;
    }

    .img {
      width: 100%;
      height: 100%;
      z-index: 999;

    }
    .paper{
      width: 800px;
      height: 800px;
      margin: 80px auto;
      border: black 1px solid;
     box-sizing: content-box;
      position: relative;
    }
    .bottom{
      width: 100%;
      height: 100px;
      position: absolute;
      bottom: 0;
      background: aqua;
      z-index: -2;
    }
  </style>
</head>

<body>
<div class="paper">
  <div class="container">
    <div class="box ">
      <div class="rotate">旋转</div>
      <img src="img/seal.jpg" alt="" class="img">
    </div>
  </div>
  <div class="bottom">吸附区</div>
</div>

  <script>
    let box = document.querySelector(".box");
    let rotate = document.querySelector(".rotate");
    let img=document.querySelector(".img")
    let paper=document.querySelector(".paper")
    let box_H = box.offsetHeight;
    let box_W = box.offsetWidth;
    let box_T = box.offsetTop;
    let box_L = box.offsetLeft;
    var pointA = { // 元素中心点 元素1/2自身宽高 + 元素的定位
      X: box_W / 2 + box_L,
      Y: box_H / 2 + box_T
    };
    var init = {
      count: 0
    }
    var pointB = {};
    var pointC = {}; // A,B,C分别代表中心点，起始点，结束点坐标
    var mPointB = {}
    // 这里通过鼠标的移动获取起始点和结束点
    var typeMouse = false;
    var allA = 0; // 存放鼠标旋转总共的度数
    var count = 0;
    // 元素跟随鼠标移动旋转
    rotate.onmousedown = function (e) {
      e.preventDefault()
      e.stopPropagation()

      typeMouse = true; //获取起始点坐标
      if (count < 1) { // 以鼠标第一次落下的点为起点
        pointB.X = e.pageX;
        pointB.Y = e.pageY;
        count++
        init.count = 0
      }
      if (mPointB.flag) { // 如果移动后,元素的B点也需要加上平移的距离
        pointB.X += mPointB.X
        pointB.Y += mPointB.Y
        mPointB.flag = false
        init.count = 0
      }
      document.onmousemove = function (e) {
        e.preventDefault()
        if (typeMouse) {
          pointC.X = e.pageX;
          pointC.Y = e.pageY; // 获取结束点坐标
          // 计算出旋转角度
          var AB = {};
          var AC = {};
          AB.X = (pointB.X - pointA.X);
          AB.Y = (pointB.Y - pointA.Y);
          AC.X = (pointC.X - pointA.X);
          AC.Y = (pointC.Y - pointA.Y); // 分别求出AB,AC的向量坐标表示
          var direct = (AB.X * AC.Y) - (AB.Y * AC.X); // AB与AC叉乘求出逆时针还是顺时针旋转
          var lengthAB = Math.sqrt(Math.pow(pointA.X - pointB.X, 2) +
              Math.pow(pointA.Y - pointB.Y, 2)),
            lengthAC = Math.sqrt(Math.pow(pointA.X - pointC.X, 2) +
              Math.pow(pointA.Y - pointC.Y, 2)),
            lengthBC = Math.sqrt(Math.pow(pointB.X - pointC.X, 2) +
              Math.pow(pointB.Y - pointC.Y, 2));
          var cosA = (Math.pow(lengthAB, 2) + Math.pow(lengthAC, 2) - Math.pow(lengthBC, 2)) /
            (2 * lengthAB * lengthAC); //   余弦定理求出旋转角
          var angleA = Math.round(Math.acos(cosA) * 180 / Math.PI);
          if (direct < 0) {
            allA = -angleA; //叉乘结果为负表示逆时针旋转， 逆时针旋转减度数
          } else {
            allA = angleA; //叉乘结果为正表示顺时针旋转，顺时针旋转加度数
          }
          box.style.transform = 'rotate(' + allA + 'deg)'
        }
      }
    }
    img.onmousedown=function (e) {
      console.log(allA)
      e.preventDefault()
      e.stopPropagation()
      moveMouse = true
      if (init.count < 1) {
        init = {
          X: e.pageX,
          Y: e.pageY,
          count: 1
        }
      }
      var dis = {
        X: e.pageX - $('.box').position().left,
        Y: e.pageY - $('.box').position().top
      }
      document.onmousemove= function (event) {
        event.preventDefault()
        event.stopPropagation()
        if (moveMouse) {
          var end = {}
          end.X = event.pageX - dis.X
          end.Y = event.pageY - dis.Y
          const PI=Math.PI
          let cAngel=allA+45;
          if(cAngel>135){
            cAngel=cAngel-90
          }
          if(cAngel<-45){
            cAngel=cAngel+90
          }
          if (allA>=0){
            if(end.X<Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.sin(cAngel*PI/180))-100)){
              end.X= Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.sin(cAngel*PI/180))-100)

            }
            if (end.X>600){
              end.X=600- Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.sin(cAngel*PI/180))-100)
            }
            if(end.Y<Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.sin(cAngel*PI/180))-100)){
              end.Y=Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.sin(cAngel*PI/180))-100)
            }
            if(end.Y>500){
              end.Y=600-Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.sin(cAngel*PI/180))-100)
            }
          }
          if(allA<0){
            if(end.X<Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.cos(cAngel*PI/180))-100)){
              end.X= Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.cos(cAngel*PI/180))-100)

            }
            if (end.X>600){
              end.X=600- Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.cos(cAngel*PI/180))-100)
            }
            if(end.Y<Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.cos(cAngel*PI/180))-100)){
              end.Y=Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.cos(cAngel*PI/180))-100)
            }
            if(end.Y>500){
              end.Y=600-Math.abs(200*Math.cos((45/180)*PI)*Math.abs(Math.cos(cAngel*PI/180))-100)
            }
          }


          $('.box').css({
            'left': end.X,
            'top': end.Y
          })
          pointA = { // 移动后,重新计算元素中心点 元素1/2自身宽高 + 元素的定位
            X: $('.box').width() / 2 + $('.box').offset().left,
            Y: $('.box').height() / 2 + $('.box').offset().top
          };
          if (count > 0) { // 保存移动的距离
            mPointB.X = event.pageX - init.X
            mPointB.Y = event.pageY - init.Y
            mPointB.flag = true
          }
        }
      }
    }
    document.onmouseup = function (e) {
      typeMouse = false;
      moveMouse = false;
    }
  </script>
</body>

</html>